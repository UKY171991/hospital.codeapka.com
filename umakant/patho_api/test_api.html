<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital API Tester - Fixed Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .api-tester { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-result { background: #212529; color: #fff; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .endpoint-card { margin-bottom: 20px; }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="api-tester">
        <div class="container-fluid">
            <h1 class="mb-4">üè• Hospital API Tester - Fixed Version</h1>
            
            <!-- Quick Test Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">üöÄ Quick API Tests</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-success me-2 mb-2" onclick="testPatientList()">Test Patient List</button>
                                    <button class="btn btn-info me-2 mb-2" onclick="testDashboard()">Test Dashboard</button>
                                    <button class="btn btn-warning me-2 mb-2" onclick="testCreatePatient()">Test Create Patient</button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-secondary me-2 mb-2" onclick="testAllAPIs()">Test All APIs</button>
                                    <button class="btn btn-danger me-2 mb-2" onclick="clearResults()">Clear Results</button>
                                    <button class="btn btn-primary me-2 mb-2" onclick="showDiagnostics()">Show Diagnostics</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom API Test -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">üîß Custom API Test</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Method</label>
                                    <select class="form-select" id="customMethod">
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                        <option value="PUT">PUT</option>
                                        <option value="DELETE">DELETE</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Endpoint</label>
                                    <input type="text" class="form-control" id="customEndpoint" 
                                           placeholder="patient.php?action=list&user_id=1&secret_key=hospital-api-secret-2024">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-primary d-block w-100" onclick="testCustomAPI()">Test Custom</button>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <label class="form-label">Request Body (JSON for POST/PUT)</label>
                                    <textarea class="form-control" id="customBody" rows="3" 
                                              placeholder='{"name": "Test Patient", "mobile": "9876543210", "age": "30", "gender": "Male"}'></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">üìä Test Results</h5>
                            <small id="lastTest"></small>
                        </div>
                        <div class="card-body p-0">
                            <div class="test-result" id="testResults">
Welcome to Hospital API Tester - Fixed Version!

üîß Common Issues Fixed:
- Added proper authentication with secret_key parameter
- Fixed user_id parameter requirement
- Improved error handling and debugging
- Added CORS headers for cross-origin requests

üöÄ Quick Start:
1. Click "Test Patient List" to test the patient API
2. Click "Test Dashboard" to test the dashboard API
3. Use "Custom API Test" for specific endpoints

üí° Authentication:
All tests use: secret_key=hospital-api-secret-2024
User-specific APIs use: user_id=1 (for testing)

Ready to test! Click any button above to start.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const BASE_URL = 'https://hospital.codeapka.com/umakant/patho_api/';
        const SECRET_KEY = 'hospital-api-secret-2024';
        const TEST_USER_ID = 1;

        function updateResults(content, status = 'info') {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            
            let statusIcon = 'üìä';
            if (status === 'success') statusIcon = '‚úÖ';
            if (status === 'error') statusIcon = '‚ùå';
            if (status === 'warning') statusIcon = '‚ö†Ô∏è';
            
            results.textContent = `${statusIcon} ${timestamp}\n\n${content}`;
            document.getElementById('lastTest').textContent = `Last test: ${timestamp}`;
        }

        function updateLastTest() {
            document.getElementById('lastTest').textContent = `Last test: ${new Date().toLocaleTimeString()}`;
        }

        async function makeAPICall(endpoint, method = 'GET', body = null) {
            try {
                const url = BASE_URL + endpoint;
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': SECRET_KEY
                    }
                };

                if (body && (method === 'POST' || method === 'PUT')) {
                    options.body = typeof body === 'string' ? body : JSON.stringify(body);
                }

                updateResults(`üîÑ Making ${method} request to:\n${url}\n\nRequest details:\n${JSON.stringify(options, null, 2)}\n\nWaiting for response...`, 'info');

                const response = await fetch(url, options);
                const data = await response.json();
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    url: url,
                    method: method,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: data
                };

                const status = response.ok ? 'success' : 'error';
                updateResults(`Response from ${method} ${endpoint}:\n\n${JSON.stringify(result, null, 2)}`, status);
                
                return result;
            } catch (error) {
                const errorResult = {
                    error: error.message,
                    endpoint: endpoint,
                    method: method,
                    timestamp: new Date().toISOString()
                };
                updateResults(`‚ùå Error testing ${endpoint}:\n\n${JSON.stringify(errorResult, null, 2)}`, 'error');
                return errorResult;
            }
        }

        async function testPatientList() {
            await makeAPICall(`patient.php?action=list&user_id=${TEST_USER_ID}&secret_key=${SECRET_KEY}`);
        }

        async function testDashboard() {
            await makeAPICall(`dashboard.php?action=overview&user_id=${TEST_USER_ID}&secret_key=${SECRET_KEY}`);
        }

        async function testCreatePatient() {
            const patientData = {
                name: `Test Patient ${Date.now()}`,
                mobile: '9876543210',
                age: '30',
                gender: 'Male',
                address: 'Test Address'
            };
            
            await makeAPICall(`patient.php?action=save&user_id=${TEST_USER_ID}&secret_key=${SECRET_KEY}`, 'POST', patientData);
        }

        async function testCustomAPI() {
            const method = document.getElementById('customMethod').value;
            const endpoint = document.getElementById('customEndpoint').value;
            const body = document.getElementById('customBody').value;
            
            if (!endpoint) {
                updateResults('‚ùå Please enter an endpoint to test', 'error');
                return;
            }
            
            let requestBody = null;
            if (body && (method === 'POST' || method === 'PUT')) {
                try {
                    requestBody = JSON.parse(body);
                } catch (e) {
                    updateResults(`‚ùå Invalid JSON in request body: ${e.message}`, 'error');
                    return;
                }
            }
            
            await makeAPICall(endpoint, method, requestBody);
        }

        async function testAllAPIs() {
            updateResults('üîÑ Testing all APIs...\n\nThis will test multiple endpoints sequentially.', 'info');
            
            const tests = [
                { name: 'Patient List', endpoint: `patient.php?action=list&user_id=${TEST_USER_ID}&secret_key=${SECRET_KEY}` },
                { name: 'Dashboard Overview', endpoint: `dashboard.php?action=overview&user_id=${TEST_USER_ID}&secret_key=${SECRET_KEY}` },
                { name: 'User List', endpoint: `user.php?action=list&secret_key=${SECRET_KEY}` },
                { name: 'Doctor List', endpoint: `doctor.php?action=list&secret_key=${SECRET_KEY}` },
                { name: 'Test List', endpoint: `test.php?action=list&secret_key=${SECRET_KEY}` }
            ];
            
            let results = 'üß™ Testing All APIs\n\n';
            
            for (const test of tests) {
                try {
                    const result = await makeAPICall(test.endpoint);
                    const status = result.status === 200 ? '‚úÖ' : '‚ùå';
                    results += `${status} ${test.name}: ${result.status} ${result.statusText}\n`;
                } catch (error) {
                    results += `‚ùå ${test.name}: Error - ${error.message}\n`;
                }
            }
            
            updateResults(results, 'info');
        }

        async function showDiagnostics() {
            await makeAPICall('fix_api_issues.php');
        }

        function clearResults() {
            updateResults('üßπ Results cleared. Ready for new tests!', 'info');
        }

        // Auto-load diagnostics on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                updateResults(`üè• Hospital API Tester - Ready!

üîß Fixed Common Issues:
- Authentication: Using secret_key parameter
- User filtering: Using user_id parameter  
- CORS: Proper headers included
- Error handling: Improved debugging

üí° Available Tests:
- Patient List: Get all patients for user
- Dashboard: Get overview statistics
- Create Patient: Add new patient record
- Custom API: Test any endpoint

üöÄ Click any test button to start!`, 'success');
            }, 500);
        });
    </script>
</body>
</html>
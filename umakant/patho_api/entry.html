<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entry Management - Patho API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .main-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; }
        .stats-card { transition: transform 0.3s ease; }
        .stats-card:hover { transform: translateY(-5px); }
        .table-container { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-action { margin: 2px; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
        .badge-status { font-size: 0.8em; }
        .loading { display: none; }
        .alert-custom { border-left: 4px solid #667eea; }
    </style>
</head>
<body>
    <!-- Main Header -->
    <div class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-clipboard-list me-3"></i>Entry Management</h1>
                    <p class="mb-0">Comprehensive test entry management with real-time updates</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" onclick="showAddEntryModal()">
                        <i class="fas fa-plus me-2"></i>Add New Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="totalEntries">0</h4>
                                <p class="mb-0">Total Entries</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clipboard-list fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="pendingEntries">0</h4>
                                <p class="mb-0">Pending</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="completedEntries">0</h4>
                                <p class="mb-0">Completed</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="todayEntries">0</h4>
                                <p class="mb-0">Today</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar-day fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Search</label>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search entries...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="statusFilter" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Patient</label>
                                <select id="patientFilter" class="form-select">
                                    <option value="">All Patients</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Test</label>
                                <select id="testFilter" class="form-select">
                                    <option value="">All Tests</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Date Range</label>
                                <input type="date" id="dateFilter" class="form-control">
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button class="btn btn-outline-primary" onclick="loadEntries()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Entries Table -->
        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Test Entries</h5>
                    </div>
                    <div class="card-body">
                        <div class="loading text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                            <p class="mt-2">Loading entries...</p>
                        </div>
                        <div class="table-responsive">
                            <table id="entriesTable" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Patient</th>
                                        <th>Test</th>
                                        <th>Result</th>
                                        <th>Unit</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Doctor</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Entry Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryModalTitle">Add New Entry</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="entryForm">
                        <input type="hidden" id="entryId" name="id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Patient <span class="text-danger">*</span></label>
                                    <select id="patientId" name="patient_id" class="form-select" required>
                                        <option value="">Select Patient</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Test <span class="text-danger">*</span></label>
                                    <select id="testId" name="test_id" class="form-select" required>
                                        <option value="">Select Test</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Doctor</label>
                                    <select id="doctorId" name="doctor_id" class="form-select">
                                        <option value="">Select Doctor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Entry Date</label>
                                    <input type="datetime-local" id="entryDate" name="entry_date" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Result Value</label>
                                    <input type="text" id="resultValue" name="result_value" class="form-control" placeholder="Enter result value">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Unit</label>
                                    <input type="text" id="unit" name="unit" class="form-control" placeholder="Unit of measurement">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select id="status" name="status" class="form-select">
                                        <option value="pending">Pending</option>
                                        <option value="completed">Completed</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea id="remarks" name="remarks" class="form-control" rows="3" placeholder="Additional remarks or notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEntry()">
                        <i class="fas fa-save me-2"></i>Save Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Entry Modal -->
    <div class="modal fade" id="viewEntryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Entry Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewEntryContent">
                    <!-- Entry details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editEntryFromView()">
                        <i class="fas fa-edit me-2"></i>Edit Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let currentEntryId = null;
        let entriesData = [];

        // Initialize the page
        $(document).ready(function() {
            loadStatistics();
            loadEntries();
            loadPatients();
            loadTests();
            loadDoctors();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Search functionality
            $('#searchInput').on('keyup', function() {
                filterEntries();
            });

            // Filter functionality
            $('#statusFilter, #patientFilter, #testFilter, #dateFilter').on('change', function() {
                filterEntries();
            });
        }

        async function loadStatistics() {
            try {
                const response = await fetch('entry.php?action=stats', {
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    $('#totalEntries').text(data.data.total || 0);
                    $('#pendingEntries').text(data.data.pending || 0);
                    $('#completedEntries').text(data.data.completed || 0);
                    $('#todayEntries').text(data.data.today || 0);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadEntries() {
            $('.loading').show();
            try {
                const response = await fetch('entry.php?action=list', {
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    entriesData = data.data;
                    displayEntries(entriesData);
                } else {
                    showAlert('Error loading entries: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Error loading entries:', error);
                showAlert('Error loading entries: ' + error.message, 'danger');
            } finally {
                $('.loading').hide();
            }
        }

        function displayEntries(entries) {
            const tbody = $('#entriesTableBody');
            tbody.empty();

            if (entries.length === 0) {
                tbody.append('<tr><td colspan="9" class="text-center text-muted">No entries found</td></tr>');
                return;
            }

            entries.forEach(entry => {
                const row = `
                    <tr>
                        <td>${entry.id}</td>
                        <td>
                            <div>
                                <strong>${entry.patient_name || 'N/A'}</strong>
                                ${entry.patient_uhid ? `<br><small class="text-muted">${entry.patient_uhid}</small>` : ''}
                            </div>
                        </td>
                        <td>${entry.test_name || 'N/A'}</td>
                        <td>${entry.result_value || '-'}</td>
                        <td>${entry.unit || '-'}</td>
                        <td><span class="badge badge-status bg-${getStatusColor(entry.status)}">${entry.status || 'pending'}</span></td>
                        <td>${formatDateTime(entry.entry_date || entry.created_at)}</td>
                        <td>${entry.doctor_name || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info btn-action" onclick="viewEntry(${entry.id})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editEntry(${entry.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteEntry(${entry.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function filterEntries() {
            const searchTerm = $('#searchInput').val().toLowerCase();
            const statusFilter = $('#statusFilter').val();
            const patientFilter = $('#patientFilter').val();
            const testFilter = $('#testFilter').val();
            const dateFilter = $('#dateFilter').val();

            let filteredEntries = entriesData.filter(entry => {
                const matchesSearch = !searchTerm || 
                    (entry.patient_name && entry.patient_name.toLowerCase().includes(searchTerm)) ||
                    (entry.test_name && entry.test_name.toLowerCase().includes(searchTerm)) ||
                    (entry.result_value && entry.result_value.toString().includes(searchTerm));

                const matchesStatus = !statusFilter || entry.status === statusFilter;
                const matchesPatient = !patientFilter || entry.patient_id == patientFilter;
                const matchesTest = !testFilter || entry.test_id == testFilter;
                
                let matchesDate = true;
                if (dateFilter) {
                    const entryDate = new Date(entry.entry_date || entry.created_at);
                    const filterDate = new Date(dateFilter);
                    matchesDate = entryDate.toDateString() === filterDate.toDateString();
                }

                return matchesSearch && matchesStatus && matchesPatient && matchesTest && matchesDate;
            });

            displayEntries(filteredEntries);
        }

        async function loadPatients() {
            try {
                const response = await fetch('../patient.php?action=list', {
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = $('#patientId, #patientFilter');
                    select.empty();
                    select.append('<option value="">Select Patient</option>');
                    
                    data.data.forEach(patient => {
                        const option = `<option value="${patient.id}">${patient.name} ${patient.uhid ? '(' + patient.uhid + ')' : ''}</option>`;
                        select.append(option);
                    });
                }
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        async function loadTests() {
            try {
                const response = await fetch('../test.php?action=list', {
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = $('#testId, #testFilter');
                    select.empty();
                    select.append('<option value="">Select Test</option>');
                    
                    data.data.forEach(test => {
                        const option = `<option value="${test.id}">${test.test_name || test.name}</option>`;
                        select.append(option);
                    });
                }
            } catch (error) {
                console.error('Error loading tests:', error);
            }
        }

        async function loadDoctors() {
            try {
                const response = await fetch('../doctor.php?action=list', {
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = $('#doctorId');
                    select.empty();
                    select.append('<option value="">Select Doctor</option>');
                    
                    data.data.forEach(doctor => {
                        const option = `<option value="${doctor.id}">${doctor.name}</option>`;
                        select.append(option);
                    });
                }
            } catch (error) {
                console.error('Error loading doctors:', error);
            }
        }

        function showAddEntryModal() {
            currentEntryId = null;
            $('#entryModalTitle').text('Add New Entry');
            $('#entryForm')[0].reset();
            $('#entryId').val('');
            $('#entryDate').val(new Date().toISOString().slice(0, 16));
            $('#entryModal').modal('show');
        }

        function editEntry(id) {
            const entry = entriesData.find(e => e.id == id);
            if (!entry) return;

            currentEntryId = id;
            $('#entryModalTitle').text('Edit Entry');
            $('#entryId').val(entry.id);
            $('#patientId').val(entry.patient_id);
            $('#testId').val(entry.test_id);
            $('#doctorId').val(entry.doctor_id);
            $('#resultValue').val(entry.result_value);
            $('#unit').val(entry.unit);
            $('#status').val(entry.status);
            $('#remarks').val(entry.remarks);
            
            if (entry.entry_date) {
                const date = new Date(entry.entry_date);
                $('#entryDate').val(date.toISOString().slice(0, 16));
            }
            
            $('#entryModal').modal('show');
        }

        async function viewEntry(id) {
            try {
                const response = await fetch(`entry.php?action=get&id=${id}`, {
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const entry = data.data;
                    const content = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Patient Information</h6>
                                <p><strong>Name:</strong> ${entry.patient_name || 'N/A'}</p>
                                <p><strong>UHID:</strong> ${entry.patient_uhid || 'N/A'}</p>
                                <p><strong>Age:</strong> ${entry.age || 'N/A'}</p>
                                <p><strong>Gender:</strong> ${entry.gender || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Test Information</h6>
                                <p><strong>Test:</strong> ${entry.test_name || 'N/A'}</p>
                                <p><strong>Result:</strong> ${entry.result_value || 'N/A'}</p>
                                <p><strong>Unit:</strong> ${entry.unit || 'N/A'}</p>
                                <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(entry.status)}">${entry.status || 'pending'}</span></p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Doctor Information</h6>
                                <p><strong>Doctor:</strong> ${entry.doctor_name || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Entry Details</h6>
                                <p><strong>Entry Date:</strong> ${formatDateTime(entry.entry_date || entry.created_at)}</p>
                                <p><strong>Added By:</strong> ${entry.added_by_username || 'N/A'}</p>
                            </div>
                        </div>
                        ${entry.remarks ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Remarks</h6>
                                    <p>${entry.remarks}</p>
                                </div>
                            </div>
                        ` : ''}
                    `;
                    
                    $('#viewEntryContent').html(content);
                    currentEntryId = id;
                    $('#viewEntryModal').modal('show');
                } else {
                    showAlert('Error loading entry: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Error loading entry:', error);
                showAlert('Error loading entry: ' + error.message, 'danger');
            }
        }

        function editEntryFromView() {
            $('#viewEntryModal').modal('hide');
            editEntry(currentEntryId);
        }

        async function saveEntry() {
            const formData = new FormData($('#entryForm')[0]);
            const data = Object.fromEntries(formData);
            
            // Remove empty values
            Object.keys(data).forEach(key => {
                if (data[key] === '') {
                    delete data[key];
                }
            });

            try {
                const response = await fetch('entry.php?action=save', {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    $('#entryModal').modal('hide');
                    loadEntries();
                    loadStatistics();
                } else {
                    showAlert('Error saving entry: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Error saving entry:', error);
                showAlert('Error saving entry: ' + error.message, 'danger');
            }
        }

        async function deleteEntry(id) {
            if (!confirm('Are you sure you want to delete this entry?')) {
                return;
            }

            try {
                const response = await fetch('entry.php?action=delete', {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': 'hospital-api-secret-2024',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Entry deleted successfully', 'success');
                    loadEntries();
                    loadStatistics();
                } else {
                    showAlert('Error deleting entry: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Error deleting entry:', error);
                showAlert('Error deleting entry: ' + error.message, 'danger');
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'success';
                case 'pending': return 'warning';
                case 'failed': return 'danger';
                default: return 'secondary';
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function showAlert(message, type) {
            const alert = `
                <div class="alert alert-${type} alert-dismissible fade show alert-custom" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').prepend(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
</body>
</html>
